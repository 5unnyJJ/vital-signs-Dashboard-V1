<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ©Ÿæ§‹å¥åº·è³‡æ–™çœ‹æ¿</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg:#ecf0ed;--bg-alt:#f3f7f4;--surface:#ffffff;
  --border:#d2e2d9;--border-light:#e5eeea;
  --mint:#7aaa96;--mint-mid:#5d9180;--mint-dark:#3d6b5a;
  --mint-light:#d8efe5;--mint-xlight:#f0f9f4;
  --text:#1e2d26;--text-mid:#486055;--text-dim:#84a098;--text-light:#b5ccc5;
  --red:#b85450;--red-light:#faeeee;
  --orange:#bf7a45;--orange-light:#faf1e6;
  --green:#5e9e72;--green-light:#e6f4eb;
  --shadow-sm:0 1px 4px rgba(40,70,55,.07);
  --shadow:0 4px 18px rgba(40,70,55,.09);
  --shadow-md:0 8px 36px rgba(40,70,55,.12);
  --r-xl:20px;--r-lg:14px;--r-md:10px;--r-sm:7px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Noto Sans TC','DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased;}

/* LOGIN */
#login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:radial-gradient(ellipse at 22% 44%,rgba(122,170,150,.16) 0%,transparent 52%),radial-gradient(ellipse at 80% 60%,rgba(93,145,128,.08) 0%,transparent 48%),var(--bg);}
.login-wrap{display:flex;background:var(--surface);border-radius:24px;box-shadow:var(--shadow-md);overflow:hidden;width:820px;max-width:93vw;}
.login-aside{width:280px;flex-shrink:0;background:linear-gradient(148deg,#72a890 0%,#3a6856 100%);padding:52px 38px;display:flex;flex-direction:column;justify-content:space-between;}
.login-brand h1{font-size:21px;font-weight:700;color:#fff;line-height:1.4;letter-spacing:-.3px;}
.login-brand small{font-size:11px;color:rgba(255,255,255,.55);letter-spacing:.6px;text-transform:uppercase;margin-top:5px;display:block;}
.login-deco{font-size:68px;opacity:.18;text-align:right;user-select:none;}
.login-form{flex:1;padding:52px 48px;display:flex;flex-direction:column;justify-content:center;}
.login-form h2{font-size:22px;font-weight:700;letter-spacing:-.4px;margin-bottom:5px;}
.login-form .sub{font-size:14px;color:var(--text-dim);margin-bottom:34px;}
.field{margin-bottom:17px;}
.field label{display:block;font-size:11px;font-weight:700;color:var(--text-mid);margin-bottom:7px;text-transform:uppercase;letter-spacing:.6px;}
.field input{width:100%;padding:12px 15px;background:var(--bg-alt);border:1.5px solid var(--border);border-radius:var(--r-md);color:var(--text);font-size:14px;font-family:inherit;outline:none;transition:border-color .18s,box-shadow .18s,background .15s;}
.field input:focus{border-color:var(--mint);background:#fff;box-shadow:0 0 0 3px rgba(122,170,150,.17);}
.remember-row{display:flex;align-items:center;gap:8px;margin:0 0 22px;}
.remember-row input[type=checkbox]{width:14px;height:14px;accent-color:var(--mint);cursor:pointer;}
.remember-row label{font-size:13px;color:var(--text-dim);cursor:pointer;}
.btn-login{width:100%;padding:13px;background:var(--mint);color:#fff;border:none;border-radius:var(--r-md);font-size:15px;font-weight:600;font-family:inherit;cursor:pointer;transition:background .18s,transform .1s;box-shadow:0 4px 14px rgba(122,170,150,.38);}
.btn-login:hover{background:var(--mint-mid);}
.btn-login:active{transform:scale(.99);}
.btn-login:disabled{opacity:.5;cursor:not-allowed;box-shadow:none;}
.error-msg{background:var(--red-light);border:1px solid rgba(184,84,80,.18);color:var(--red);padding:10px 14px;border-radius:var(--r-sm);font-size:13px;margin-bottom:15px;display:none;}
@media(max-width:600px){.login-aside{display:none;}.login-form{padding:36px 24px;}}

/* TOPBAR */
#dashboard{display:none;}
.topbar{position:sticky;top:0;z-index:300;display:flex;align-items:center;justify-content:space-between;height:62px;padding:0 40px;background:rgba(255,255,255,.92);backdrop-filter:blur(14px);border-bottom:1px solid var(--border-light);}
.topbar-brand{display:flex;align-items:center;gap:8px;font-size:15px;font-weight:700;color:var(--mint-dark);letter-spacing:-.2px;}
.topbar-right{display:flex;align-items:center;gap:10px;}
.user-chip{display:flex;align-items:center;gap:7px;padding:4px 13px 4px 5px;background:var(--mint-xlight);border:1.5px solid var(--mint-light);border-radius:40px;}
.user-avatar{width:28px;height:28px;background:var(--mint);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;}
.user-chip span{font-size:13px;color:var(--text-mid);font-weight:500;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.btn-logout{padding:7px 15px;background:transparent;border:1.5px solid var(--border);border-radius:var(--r-sm);color:var(--text-dim);font-size:13px;font-family:inherit;cursor:pointer;transition:all .18s;}
.btn-logout:hover{border-color:var(--red);color:var(--red);background:var(--red-light);}

/* Realtime badge */
.rt-badge{display:inline-flex;align-items:center;gap:5px;padding:5px 11px;border-radius:20px;font-size:12px;font-weight:600;background:rgba(239,68,68,.1);color:#b85450;border:1px solid rgba(184,84,80,.2);}
.rt-badge.active{background:rgba(94,158,114,.12);color:#2d6b40;border-color:rgba(94,158,114,.25);}
.rt-dot{width:7px;height:7px;border-radius:50%;background:currentColor;}
.rt-dot.pulse{animation:rtpulse 1.2s ease infinite;}
@keyframes rtpulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.4;transform:scale(.8);}}

/* MAIN */
.main{padding:36px 40px;max-width:1500px;margin:0 auto;}
.page-header{margin-bottom:28px;}
.page-header h1{font-size:24px;font-weight:700;letter-spacing:-.4px;margin-bottom:3px;}
.page-header p{font-size:13px;color:var(--text-dim);}

/* TABS */
.tabs{display:flex;gap:9px;margin-bottom:24px;flex-wrap:wrap;}
.tab{display:flex;align-items:center;gap:6px;padding:9px 22px;background:var(--surface);border:1.5px solid var(--border);border-radius:40px;color:var(--text-dim);font-size:14px;font-weight:500;font-family:inherit;cursor:pointer;transition:all .18s;box-shadow:var(--shadow-sm);}
.tab:hover{border-color:var(--mint);color:var(--mint-dark);background:var(--mint-xlight);}
.tab.active{background:var(--mint);border-color:var(--mint);color:#fff;box-shadow:0 3px 12px rgba(122,170,150,.38);}
.tab-dot{width:6px;height:6px;border-radius:50%;background:currentColor;opacity:.7;flex-shrink:0;}

/* VIEW TOGGLE */
.view-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:10px;}
.view-toggle{display:flex;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);overflow:hidden;box-shadow:var(--shadow-sm);}
.view-btn{padding:8px 20px;background:transparent;border:none;font-size:13px;font-weight:600;font-family:inherit;color:var(--text-dim);cursor:pointer;transition:all .15s;}
.view-btn:hover{background:var(--bg-alt);color:var(--mint-dark);}
.view-btn.active{background:var(--mint);color:#fff;}

/* NAV BAR */
.nav-bar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.date-nav{display:flex;align-items:center;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);overflow:hidden;box-shadow:var(--shadow-sm);}
.date-nav-btn{padding:9px 15px;background:transparent;border:none;color:var(--text-mid);font-size:17px;cursor:pointer;transition:background .15s;display:flex;align-items:center;}
.date-nav-btn:hover{background:var(--bg-alt);color:var(--mint-dark);}
.date-display{padding:9px 18px;font-size:15px;font-weight:700;color:var(--text);letter-spacing:-.2px;white-space:nowrap;border-left:1px solid var(--border-light);border-right:1px solid var(--border-light);}
.btn-today{padding:9px 14px;background:transparent;border:none;font-size:12px;font-weight:700;color:var(--mint-mid);font-family:inherit;cursor:pointer;transition:background .15s;}
.btn-today:hover{background:var(--mint-xlight);}
.btn-search{display:flex;align-items:center;gap:6px;padding:9px 16px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);color:var(--text-mid);font-size:13px;font-family:inherit;cursor:pointer;transition:all .18s;box-shadow:var(--shadow-sm);}
.btn-search:hover{border-color:var(--mint);color:var(--mint-dark);background:var(--mint-xlight);}

/* Auto-refresh */
.refresh-selector{display:flex;align-items:center;gap:6px;}
.refresh-selector label{font-size:12px;color:var(--text-dim);white-space:nowrap;}
.refresh-selector select{padding:7px 10px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-sm);color:var(--text-mid);font-size:12px;font-family:inherit;cursor:pointer;outline:none;}
.refresh-selector select:focus{border-color:var(--mint);}
.refresh-countdown{font-size:11px;color:var(--mint-mid);font-weight:700;font-feature-settings:'tnum';min-width:28px;}

/* SEARCH OVERLAY */
.search-overlay{display:none;position:fixed;inset:0;z-index:500;}
.search-overlay.open{display:block;}
.search-backdrop{position:absolute;inset:0;}
.search-dialog{position:absolute;top:110px;left:50%;transform:translateX(-50%);background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-xl);box-shadow:var(--shadow-md);padding:26px 28px;width:340px;max-width:90vw;}
.search-dialog h3{font-size:15px;font-weight:700;margin-bottom:4px;}
.search-dialog p{font-size:12.5px;color:var(--text-dim);margin-bottom:16px;}
.search-input{width:100%;padding:11px 14px;background:var(--bg-alt);border:1.5px solid var(--border);border-radius:var(--r-md);font-size:14px;font-family:inherit;color:var(--text);outline:none;margin-bottom:11px;transition:border-color .18s,box-shadow .18s;}
.search-input:focus{border-color:var(--mint);box-shadow:0 0 0 3px rgba(122,170,150,.17);background:#fff;}
.search-quick{display:flex;gap:7px;margin-bottom:14px;flex-wrap:wrap;}
.quick-btn{padding:6px 12px;background:var(--bg-alt);border:1.5px solid var(--border);border-radius:20px;font-size:12px;font-weight:600;color:var(--text-mid);font-family:inherit;cursor:pointer;transition:all .15s;}
.quick-btn:hover{background:var(--mint-xlight);border-color:var(--mint);color:var(--mint-dark);}
.btn-search-go{width:100%;padding:11px;background:var(--mint);color:#fff;border:none;border-radius:var(--r-md);font-size:14px;font-weight:600;font-family:inherit;cursor:pointer;transition:background .18s;}
.btn-search-go:hover{background:var(--mint-mid);}

/* TOOLBAR */
.toolbar{display:flex;align-items:center;justify-content:space-between;margin:16px 0;gap:10px;flex-wrap:wrap;}
.count-badge{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r-sm);font-size:13px;color:var(--text-mid);box-shadow:var(--shadow-sm);}
.count-badge strong{color:var(--text);font-weight:700;}
.toolbar-right{display:flex;gap:8px;align-items:center;}
.btn-refresh{display:flex;align-items:center;gap:6px;padding:8px 16px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-sm);color:var(--text-mid);font-size:13px;font-family:inherit;cursor:pointer;transition:all .18s;box-shadow:var(--shadow-sm);}
.btn-refresh:hover{border-color:var(--mint);color:var(--mint-dark);background:var(--mint-xlight);}
.btn-refresh.spinning svg{animation:spin .6s linear infinite;}

/* CONTENT */
#table-content{display:flex;flex-direction:column;gap:14px;}

/* DATE CARD */
.date-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-xl);overflow:hidden;box-shadow:var(--shadow-sm);transition:box-shadow .2s;}
.date-card:hover{box-shadow:var(--shadow);}
.date-header{display:flex;align-items:center;justify-content:space-between;padding:20px 26px;cursor:pointer;user-select:none;transition:background .15s;}
.date-header:hover{background:var(--bg-alt);}
.date-header-left{display:flex;align-items:center;gap:14px;}
.date-icon{width:42px;height:42px;background:var(--mint-light);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0;}
.date-label{font-size:16px;font-weight:700;letter-spacing:-.3px;}
.date-meta{font-size:12.5px;color:var(--text-dim);margin-top:2px;}
.date-chevron{width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:7px;color:var(--text-light);transition:transform .25s ease,color .15s;}
.date-card.open .date-chevron{transform:rotate(180deg);color:var(--mint);}
.date-body{display:none;padding:0 16px 16px;flex-direction:column;gap:8px;}
.date-card.open .date-body{display:flex;}

/* HOUR CARD */
.hour-card{background:var(--bg-alt);border:1.5px solid var(--border-light);border-radius:var(--r-lg);overflow:hidden;}
.hour-header{display:flex;align-items:center;gap:10px;padding:13px 18px;cursor:pointer;user-select:none;transition:background .15s;}
.hour-header:hover{background:var(--mint-xlight);}
.hour-label{font-size:14px;font-weight:700;font-feature-settings:'tnum';flex-shrink:0;}
.hour-count{font-size:11.5px;color:var(--text-dim);background:var(--surface);border:1px solid var(--border);padding:2px 9px;border-radius:20px;flex-shrink:0;}
.hour-stats{display:flex;align-items:center;gap:12px;flex:1;flex-wrap:wrap;}
.stat-chip{display:flex;align-items:center;gap:4px;font-size:12px;color:var(--text-mid);}
.stat-icon{font-size:12px;}
.stat-val{font-weight:700;color:var(--text);font-feature-settings:'tnum';}
.stat-val.is-red{color:var(--red);}
.stat-val.is-orange{color:var(--orange);}
.hour-chevron{width:20px;height:20px;display:flex;align-items:center;justify-content:center;color:var(--text-light);transition:transform .2s;flex-shrink:0;margin-left:auto;}
.hour-card.open .hour-chevron{transform:rotate(180deg);}
.hour-body{display:none;border-top:1px solid var(--border-light);}
.hour-card.open .hour-body{display:block;}
.sparkline-area{display:flex;align-items:center;gap:28px;padding:14px 20px 11px;background:var(--surface);border-bottom:1px solid var(--border-light);overflow-x:auto;}
.spark-item{display:flex;flex-direction:column;gap:4px;}
.spark-label{font-size:10.5px;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:.6px;}

/* New row flash */
@keyframes newrow{from{background:rgba(122,170,150,.22);}to{background:transparent;}}
.row-new td{animation:newrow 2s ease forwards;}

/* DATA TABLE */
.data-table-wrap{overflow-x:auto;background:var(--surface);}
.data-table{width:100%;border-collapse:collapse;font-size:13px;min-width:860px;}
.data-table thead th{padding:12px 16px;text-align:left;font-weight:700;font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:.7px;background:var(--bg-alt);border-bottom:1px solid var(--border-light);white-space:nowrap;}
.data-table tbody td{padding:13px 16px;border-bottom:1px solid var(--border-light);white-space:nowrap;vertical-align:middle;}
.data-table tbody tr:hover td{background:var(--mint-xlight);}
.data-table tbody tr:last-child td{border-bottom:none;}
.val-neutral{font-size:13px;color:var(--text);font-feature-settings:'tnum';}
.val-dim{color:var(--text-light);}
.val-badge{display:inline-block;padding:3px 10px;border-radius:6px;font-size:12.5px;font-weight:700;font-feature-settings:'tnum';}
.val-green{background:var(--green-light);color:#2d6b40;}
.val-orange{background:var(--orange-light);color:#7a4818;}
.val-red{background:var(--red-light);color:#862624;}
.val-count{font-size:11px;color:var(--text-dim);background:var(--bg-alt);padding:2px 8px;border-radius:5px;}

/* MONTH VIEW */
.month-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:14px;}
.day-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:20px 22px;box-shadow:var(--shadow-sm);cursor:pointer;transition:all .2s;position:relative;overflow:hidden;}
.day-card:hover{box-shadow:var(--shadow);border-color:var(--mint);transform:translateY(-1px);}
.day-card.loading-day::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--mint-light),var(--mint),var(--mint-light));background-size:200% 100%;animation:shimmer 1.2s linear infinite;}
@keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
.day-card-date{font-size:15px;font-weight:700;letter-spacing:-.2px;margin-bottom:12px;}
.day-card-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.day-stat{display:flex;flex-direction:column;gap:2px;}
.day-stat-label{font-size:10px;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px;}
.day-stat-val{font-size:15px;font-weight:700;color:var(--text);font-feature-settings:'tnum';}
.day-stat-val.is-red{color:var(--red);}
.day-stat-val.is-orange{color:var(--orange);}
.day-card-footer{margin-top:14px;font-size:11.5px;color:var(--text-dim);display:flex;align-items:center;justify-content:space-between;}
.day-card.no-data{opacity:.5;cursor:default;}
.day-card.no-data:hover{transform:none;border-color:var(--border);box-shadow:var(--shadow-sm);}

/* PAGINATION */
.pagination{display:flex;align-items:center;justify-content:center;gap:6px;padding:20px 0 4px;flex-wrap:wrap;}
.page-btn{min-width:36px;height:36px;padding:0 10px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-sm);font-size:13px;font-weight:500;color:var(--text-mid);font-family:inherit;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;}
.page-btn:hover{border-color:var(--mint);color:var(--mint-dark);background:var(--mint-xlight);}
.page-btn.active{background:var(--mint);border-color:var(--mint);color:#fff;box-shadow:0 2px 8px rgba(122,170,150,.35);}
.page-btn:disabled{opacity:.4;cursor:default;}
.page-info{font-size:12px;color:var(--text-dim);padding:0 4px;}

/* STATES */
.state-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-xl);padding:72px 32px;text-align:center;color:var(--text-dim);font-size:15px;box-shadow:var(--shadow-sm);}
.loading-spinner{display:inline-block;width:17px;height:17px;border:2px solid var(--border);border-top-color:var(--mint);border-radius:50%;animation:spin .7s linear infinite;margin-right:8px;vertical-align:middle;}
@keyframes spin{to{transform:rotate(360deg);}}
.progress-wrap{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-xl);padding:40px;text-align:center;box-shadow:var(--shadow-sm);}
.progress-label{font-size:14px;color:var(--text-mid);margin-bottom:16px;}
.progress-bar-bg{width:100%;max-width:320px;height:6px;background:var(--border);border-radius:10px;margin:0 auto;}
.progress-bar-fill{height:6px;background:var(--mint);border-radius:10px;transition:width .3s ease;width:0%;}
.progress-note{font-size:12px;color:var(--text-dim);margin-top:10px;}

@media(max-width:800px){.topbar,.main{padding-left:16px;padding-right:16px;}.hour-stats,.sparkline-area{display:none;}.month-grid{grid-template-columns:1fr 1fr;}}
@media(max-width:480px){.month-grid{grid-template-columns:1fr;}}
</style>
</head>
<body>

<div id="login-screen">
  <div class="login-wrap">
    <div class="login-aside">
      <div class="login-brand"><h1>æ©Ÿæ§‹å¥åº·<br>è³‡æ–™çœ‹æ¿</h1><small>Healthcare Dashboard</small></div>
      <div class="login-deco">ğŸŒ¿</div>
    </div>
    <div class="login-form">
      <h2>æ­¡è¿å›ä¾†</h2>
      <p class="sub">è«‹ä½¿ç”¨å·²æˆæ¬Šçš„å¸³è™Ÿç™»å…¥</p>
      <div class="error-msg" id="login-error"></div>
      <div class="field"><label>Email</label><input type="email" id="email" placeholder="your@email.com" autocomplete="email"></div>
      <div class="field"><label>å¯†ç¢¼</label><input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"></div>
      <div class="remember-row"><input type="checkbox" id="remember"><label for="remember">è¨˜ä½å¸³è™Ÿèˆ‡å¯†ç¢¼</label></div>
      <button class="btn-login" id="btn-login" onclick="doLogin()">ç™»å…¥</button>
    </div>
  </div>
</div>

<div class="search-overlay" id="search-overlay">
  <div class="search-backdrop" onclick="closeSearch()"></div>
  <div class="search-dialog">
    <h3>ğŸ” æŸ¥è©¢è³‡æ–™</h3>
    <p>è¼¸å…¥æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰æˆ–å¹´æœˆï¼ˆYYYY-MMï¼‰</p>
    <input class="search-input" id="search-input" placeholder="ä¾‹ï¼š2025-06-15 æˆ– 2025-06" onkeydown="if(event.key==='Enter')doSearch()">
    <div class="search-quick">
      <button class="quick-btn" onclick="quickDate(0)">ä»Šå¤©</button>
      <button class="quick-btn" onclick="quickDate(-1)">æ˜¨å¤©</button>
      <button class="quick-btn" onclick="quickDate(-7)">ä¸€é€±å‰</button>
      <button class="quick-btn" onclick="quickMonth(0)">æœ¬æœˆ</button>
      <button class="quick-btn" onclick="quickMonth(-1)">ä¸Šå€‹æœˆ</button>
    </div>
    <button class="btn-search-go" onclick="doSearch()">å‰å¾€æŸ¥è©¢</button>
  </div>
</div>

<div id="dashboard">
  <div class="topbar">
    <div class="topbar-brand">ğŸŒ¿ å¥åº·è³‡æ–™çœ‹æ¿</div>
    <div class="topbar-right">
      <div class="rt-badge" id="rt-badge"><span class="rt-dot" id="rt-dot"></span><span id="rt-label">é›¢ç·š</span></div>
      <div class="user-chip"><div class="user-avatar" id="user-avatar">?</div><span id="user-email"></span></div>
      <button class="btn-logout" onclick="doLogout()">ç™»å‡º</button>
    </div>
  </div>
  <div class="main">
    <div class="page-header"><h1 id="page-title">å¥åº·è³‡æ–™ç¸½è¦½</h1><p id="page-sub">é¸æ“‡ä¸‹æ–¹æ©Ÿæ§‹é–‹å§‹æŸ¥é–±</p></div>
    <div class="tabs" id="tabs"></div>
    <div class="view-row">
      <div class="nav-bar">
        <div class="view-toggle">
          <button class="view-btn active" id="view-day-btn" onclick="setView('day')">ğŸ“… æ—¥è¦–åœ–</button>
          <button class="view-btn" id="view-month-btn" onclick="setView('month')">ğŸ“† æœˆè¦–åœ–</button>
        </div>
        <div class="date-nav">
          <button class="date-nav-btn" onclick="navPrev()">&#8592;</button>
          <div class="date-display" id="date-display">â€”</div>
          <button class="date-nav-btn" onclick="navNext()">&#8594;</button>
          <button class="btn-today" onclick="goToday()">ä»Šå¤©</button>
        </div>
        <button class="btn-search" onclick="openSearch()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>æŸ¥è©¢
        </button>
      </div>
    </div>
    <div class="toolbar">
      <div class="count-badge" id="row-count" style="visibility:hidden">â€”</div>
      <div class="toolbar-right">
        <div class="refresh-selector">
          <label>è‡ªå‹•æ›´æ–°</label>
          <select id="refresh-interval" onchange="setAutoRefresh()">
            <option value="0">é—œé–‰</option>
            <option value="30" selected>30 ç§’</option>
            <option value="60">1 åˆ†é˜</option>
            <option value="300">5 åˆ†é˜</option>
          </select>
          <span class="refresh-countdown" id="refresh-countdown"></span>
        </div>
        <button class="btn-refresh" id="btn-refresh" onclick="manualRefresh()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>é‡æ–°æ•´ç†
        </button>
      </div>
    </div>
    <div id="table-content"><div class="state-card">è«‹é¸æ“‡æ©Ÿæ§‹</div></div>
    <div id="pagination-wrap" class="pagination"></div>
  </div>
</div>

<script>
const SUPABASE_URL='https://lrrxswxvphoeyuvemvin.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxycnhzd3h2cGhvZXl1dmVtdmluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMzU1NjksImV4cCI6MjA4MzkxMTU2OX0.54qS-CTVL9XeIbNO83r8spsRrk8woyBz3u-HoRdFxHs';
let sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const ACCESS_MAP={'dulancliniccloud@gmail.com':['DC_data_base'],'ttricloudtest001@gmail.com':['CY_data_base','YK_data_base'],'kingpig4628@gmail.com':['DC_data_base','CY_data_base','YK_data_base'],'zywu.1487@gmail.com':['DC_data_base','CY_data_base','YK_data_base']',ttrismartextilegpt@gmail.com':  ['DC_data_base', 'CY_data_base', 'YK_data_base']};
const TABLE_LABEL={'DC_data_base':'éƒ½è˜­è¨ºæ‰€','CY_data_base':'å˜‰ç¾©é†«é™¢','YK_data_base':'å“¡éƒ­é†«é™¢'};
const AGG_COLS=[{key:'time',label:'åˆ†é˜',badge:false},{key:'count',label:'ç­†æ•¸',badge:false},{key:'heartbeat',label:'å¿ƒè·³ avg',badge:true},{key:'temp',label:'é«”æº« avg',badge:true},{key:'breath',label:'å‘¼å¸ avg',badge:false},{key:'sbp',label:'æ”¶ç¸®å£“ avg',badge:true},{key:'dbp',label:'èˆ’å¼µå£“ avg',badge:true},{key:'pulse',label:'è„ˆæ avg',badge:false},{key:'step',label:'æ­¥æ•¸ avg',badge:false},{key:'calorie',label:'å¡è·¯é‡Œ avg',badge:false}];
const HOURS_PER_PAGE=6;

let currentTable=null,currentDate=todayStr(),currentMonth=monthStr(),currentView='day';
let currentPage=1,totalPages=1,groupedCache=null,rawRowsCache=[];
let rtChannel=null,arInterval=30,arTimer=null,arCountdown=0;

function anomalyLevel(key,v){if(v===null||v===undefined)return'neutral';const n=parseFloat(v);if(isNaN(n))return'neutral';switch(key){case'sbp':return n>=160||n<80?'red':n>=140||n<90?'orange':'green';case'dbp':return n>=100||n<55?'red':n>=90||n<60?'orange':'green';case'heartbeat':return n>120||n<50?'red':n>100||n<60?'orange':'green';case'temp':return n>38||n<36?'red':n>37.2?'orange':'green';default:return'neutral';}}

function sparkline(values,stroke,w=180,h=32){const nums=values.map(v=>parseFloat(v)).filter(v=>!isNaN(v));if(nums.length<2)return`<svg width="${w}" height="${h}"><text x="4" y="18" font-size="10" fill="#b5ccc5">â€”</text></svg>`;const mn=Math.min(...nums),mx=Math.max(...nums),rng=mx-mn||1,p=3;const pts=nums.map((v,i)=>{const x=p+(i/(nums.length-1))*(w-p*2);const y=(h-p)-((v-mn)/rng)*(h-p*2)+p/2;return`${x.toFixed(1)},${y.toFixed(1)}`;}).join(' ');return`<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}"><polyline points="${pts}" fill="none" stroke="${stroke}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;}

function p2(n){return String(n).padStart(2,'0');}
function todayStr(){const d=new Date();return`${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())}`;}
function monthStr(offset=0){const d=new Date();d.setMonth(d.getMonth()+offset);return`${d.getFullYear()}-${p2(d.getMonth()+1)}`;}
function formatMinute(iso){if(!iso)return'â€”';const d=new Date(iso);return`${p2(d.getHours())}:${p2(d.getMinutes())}`;}
function avg(arr){const n=arr.map(v=>parseFloat(v)).filter(v=>!isNaN(v));if(!n.length)return null;return Math.round(n.reduce((a,b)=>a+b,0)/n.length*10)/10;}

function setView(v){currentView=v;document.getElementById('view-day-btn').classList.toggle('active',v==='day');document.getElementById('view-month-btn').classList.toggle('active',v==='month');currentPage=1;updateDateDisplay();loadCurrentTable();}
function updateDateDisplay(){document.getElementById('date-display').textContent=currentView==='day'?currentDate:currentMonth;}

function navPrev(){if(currentView==='day'){const d=new Date(currentDate+'T00:00:00');d.setDate(d.getDate()-1);currentDate=`${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())}`;}else{const[y,m]=currentMonth.split('-').map(Number);const d=new Date(y,m-2,1);currentMonth=`${d.getFullYear()}-${p2(d.getMonth()+1)}`;}currentPage=1;loadCurrentTable();}
function navNext(){if(currentView==='day'){const d=new Date(currentDate+'T00:00:00');d.setDate(d.getDate()+1);currentDate=`${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())}`;}else{const[y,m]=currentMonth.split('-').map(Number);const d=new Date(y,m,1);currentMonth=`${d.getFullYear()}-${p2(d.getMonth()+1)}`;}currentPage=1;loadCurrentTable();}
function goToday(){currentDate=todayStr();currentMonth=monthStr();currentPage=1;loadCurrentTable();}

function openSearch(){document.getElementById('search-overlay').classList.add('open');document.getElementById('search-input').focus();}
function closeSearch(){document.getElementById('search-overlay').classList.remove('open');}
function quickDate(delta){const d=new Date();d.setDate(d.getDate()+delta);document.getElementById('search-input').value=`${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())}`;}
function quickMonth(delta){document.getElementById('search-input').value=monthStr(delta);}
function doSearch(){const raw=document.getElementById('search-input').value.trim();if(!raw)return;if(/^\d{4}-\d{2}-\d{2}$/.test(raw)){currentDate=raw;currentView='day';document.getElementById('view-day-btn').classList.add('active');document.getElementById('view-month-btn').classList.remove('active');}else if(/^\d{4}-\d{2}$/.test(raw)){currentMonth=raw;currentView='month';document.getElementById('view-day-btn').classList.remove('active');document.getElementById('view-month-btn').classList.add('active');}else{alert('æ ¼å¼ä¸å°ï¼Œè«‹è¼¸å…¥ YYYY-MM-DD æˆ– YYYY-MM');return;}currentPage=1;closeSearch();loadCurrentTable();}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeSearch();});

function setAutoRefresh(){arInterval=parseInt(document.getElementById('refresh-interval').value)||0;clearInterval(arTimer);document.getElementById('refresh-countdown').textContent='';if(arInterval>0)startCountdown();}
function startCountdown(){arCountdown=arInterval;updateCountdownUI();arTimer=setInterval(()=>{arCountdown--;updateCountdownUI();if(arCountdown<=0){arCountdown=arInterval;const isToday=(currentView==='day'&&currentDate===todayStr())||(currentView==='month'&&currentMonth===monthStr());if(isToday)silentRefresh();}},1000);}
function updateCountdownUI(){const el=document.getElementById('refresh-countdown');el.textContent=arInterval?arCountdown+'s':'';}

function subscribeRealtime(table){if(rtChannel){sb.removeChannel(rtChannel);rtChannel=null;}setRtBadge(false,'é€£ç·šä¸­â€¦');rtChannel=sb.channel('rt-'+table).on('postgres_changes',{event:'INSERT',schema:'public',table:table},handleRealtimeInsert).subscribe(status=>{if(status==='SUBSCRIBED')setRtBadge(true,'å³æ™‚');if(status==='CLOSED')setRtBadge(false,'é›¢ç·š');if(status==='CHANNEL_ERROR')setRtBadge(false,'éŒ¯èª¤');});}
function setRtBadge(active,label){const badge=document.getElementById('rt-badge');const dot=document.getElementById('rt-dot');const lbl=document.getElementById('rt-label');badge.classList.toggle('active',active);dot.classList.toggle('pulse',active);lbl.textContent=label;}
function handleRealtimeInsert(payload){if(currentView!=='day')return;const row=payload.new;if(!row||!row.date_minute)return;if(row.date_minute.slice(0,10)!==currentDate)return;rawRowsCache.push(row);groupedCache=groupByHour(aggregateToMinutes(rawRowsCache));renderPage();setTimeout(()=>{const tb=document.querySelector('.data-table tbody');if(tb&&tb.firstElementChild)tb.firstElementChild.classList.add('row-new');},50);}

function loadRemembered(){const em=localStorage.getItem('rm_email'),pw=localStorage.getItem('rm_pass');if(em){document.getElementById('email').value=em;document.getElementById('remember').checked=true;}if(pw){try{document.getElementById('password').value=atob(pw);}catch(e){}}}
async function doLogin(){const email=document.getElementById('email').value.trim(),pass=document.getElementById('password').value,remember=document.getElementById('remember').checked,errEl=document.getElementById('login-error'),btn=document.getElementById('btn-login');errEl.style.display='none';if(!email||!pass){errEl.textContent='è«‹å¡«å¯« Email å’Œå¯†ç¢¼';errEl.style.display='block';return;}if(!ACCESS_MAP[email]){errEl.textContent='æ­¤å¸³è™Ÿç„¡å­˜å–æ¬Šé™';errEl.style.display='block';return;}btn.disabled=true;btn.textContent='ç™»å…¥ä¸­â€¦';const{data,error}=await sb.auth.signInWithPassword({email,password:pass});if(error){errEl.textContent='ç™»å…¥å¤±æ•—ï¼š'+error.message;errEl.style.display='block';btn.disabled=false;btn.textContent='ç™»å…¥';return;}if(remember){localStorage.setItem('rm_email',email);localStorage.setItem('rm_pass',btoa(pass));}else{localStorage.removeItem('rm_email');localStorage.removeItem('rm_pass');}showDashboard(email);}
document.addEventListener('keydown',e=>{if(e.key==='Enter'&&document.getElementById('login-screen').style.display!=='none')doLogin();});

async function doLogout(){clearInterval(arTimer);if(rtChannel){sb.removeChannel(rtChannel);rtChannel=null;}await sb.auth.signOut({scope:'local'});Object.keys(localStorage).forEach(k=>{if(k.startsWith('sb-'))localStorage.removeItem(k);});sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);currentTable=null;groupedCache=null;rawRowsCache=[];document.getElementById('dashboard').style.display='none';document.getElementById('login-screen').style.display='flex';document.getElementById('btn-login').disabled=false;document.getElementById('btn-login').textContent='ç™»å…¥';document.getElementById('login-error').style.display='none';setRtBadge(false,'é›¢ç·š');loadRemembered();}

function showDashboard(email){document.getElementById('login-screen').style.display='none';document.getElementById('dashboard').style.display='block';document.getElementById('user-email').textContent=email;document.getElementById('user-avatar').textContent=email[0].toUpperCase();const tables=ACCESS_MAP[email]||[];const tabsEl=document.getElementById('tabs');tabsEl.innerHTML='';tables.forEach((t,i)=>{const btn=document.createElement('button');btn.className='tab'+(i===0?' active':'');btn.innerHTML=`<span class="tab-dot"></span>${TABLE_LABEL[t]||t}`;btn.onclick=()=>switchTable(t,btn);tabsEl.appendChild(btn);});currentDate=todayStr();currentMonth=monthStr();if(tables.length>0)switchTable(tables[0],tabsEl.querySelector('.tab'));setAutoRefresh();}
function switchTable(name,btnEl){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));if(btnEl)btnEl.classList.add('active');currentTable=name;currentPage=1;groupedCache=null;rawRowsCache=[];subscribeRealtime(name);loadCurrentTable();}

async function loadCurrentTable(){if(!currentTable)return;updateDateDisplay();if(currentView==='day')await loadDayView();else await loadMonthView();}
async function manualRefresh(){const btn=document.getElementById('btn-refresh');btn.classList.add('spinning');await loadCurrentTable();btn.classList.remove('spinning');}
async function silentRefresh(){if(!currentTable||currentView!=='day')return;const rawRows=await fetchDay(currentTable,currentDate,true);if(!rawRows.length)return;rawRowsCache=rawRows;groupedCache=groupByHour(aggregateToMinutes(rawRows));renderPage();const countEl=document.getElementById('row-count');countEl.style.visibility='visible';countEl.innerHTML=`åŸå§‹ <strong>${rawRows.length.toLocaleString()}</strong> ç­† â†’ èšåˆ <strong>${aggregateToMinutes(rawRows).length.toLocaleString()}</strong> åˆ†é˜`;}

async function fetchDay(table,date,silent=false){const start=date+'T00:00:00',end=date+'T23:59:59.999';let all=[],page=0;const pageSize=1000;const pfill=document.querySelector('.progress-bar-fill'),plabel=document.querySelector('.progress-label');while(true){const{data,error}=await sb.from(table).select('date_minute,heartbeat,temp,breath,sbp,dbp,pulse,step,calorie,member_id').gte('date_minute',start).lte('date_minute',end).order('date_minute',{ascending:true}).range(page*pageSize,(page+1)*pageSize-1);if(error||!data||!data.length)break;all=all.concat(data);if(!silent&&pfill){const pct=Math.min(Math.round(all.length/900),95);pfill.style.width=pct+'%';if(plabel)plabel.textContent=`è¼‰å…¥ä¸­â€¦ å·²å–å¾— ${all.length.toLocaleString()} ç­†`;}if(data.length<pageSize)break;page++;}if(!silent&&pfill)pfill.style.width='100%';return all;}
async function fetchDaySummary(table,date){const start=date+'T00:00:00',end=date+'T23:59:59.999';const{data,error}=await sb.from(table).select('date_minute,heartbeat,temp,sbp,dbp').gte('date_minute',start).lte('date_minute',end).limit(3000);if(error||!data)return null;return data;}

async function loadDayView(){const content=document.getElementById('table-content'),countEl=document.getElementById('row-count'),pagWrap=document.getElementById('pagination-wrap');countEl.style.visibility='hidden';pagWrap.innerHTML='';groupedCache=null;rawRowsCache=[];content.innerHTML=`<div class="progress-wrap"><div class="progress-label">è¼‰å…¥ä¸­â€¦</div><div class="progress-bar-bg"><div class="progress-bar-fill"></div></div><div class="progress-note">æ­£åœ¨å–å¾— ${currentDate} çš„è³‡æ–™</div></div>`;const rawRows=await fetchDay(currentTable,currentDate);if(!rawRows.length){content.innerHTML=`<div class="state-card">ğŸ“­ ${currentDate} æ²’æœ‰è³‡æ–™</div>`;countEl.style.visibility='visible';countEl.innerHTML='å…± <strong>0</strong> ç­†';return;}rawRowsCache=rawRows;const minuteRows=aggregateToMinutes(rawRows);groupedCache=groupByHour(minuteRows);const hourKeys=Object.keys(groupedCache).sort();totalPages=Math.ceil(hourKeys.length/HOURS_PER_PAGE);if(currentPage>totalPages)currentPage=totalPages;countEl.style.visibility='visible';countEl.innerHTML=`åŸå§‹ <strong>${rawRows.length.toLocaleString()}</strong> ç­† â†’ èšåˆ <strong>${minuteRows.length.toLocaleString()}</strong> åˆ†é˜`;renderPage();}

async function loadMonthView(){const content=document.getElementById('table-content'),countEl=document.getElementById('row-count'),pagWrap=document.getElementById('pagination-wrap');countEl.style.visibility='hidden';pagWrap.innerHTML='';content.innerHTML='';const[yr,mo]=currentMonth.split('-').map(Number);const daysInMonth=new Date(yr,mo,0).getDate();const grid=document.createElement('div');grid.className='month-grid';content.appendChild(grid);const cardMap={};for(let d=1;d<=daysInMonth;d++){const ds=`${yr}-${p2(mo)}-${p2(d)}`;const card=document.createElement('div');card.className='day-card loading-day';card.innerHTML=`<div class="day-card-date">ğŸ“… ${ds}</div><div class="day-card-stats"><div class="day-stat"><div class="day-stat-label">è¼‰å…¥ä¸­</div><div class="day-stat-val" style="color:var(--text-light)">â€¦</div></div></div>`;grid.appendChild(card);cardMap[ds]=card;}for(let d=1;d<=daysInMonth;d++){const ds=`${yr}-${p2(mo)}-${p2(d)}`;const card=cardMap[ds];const rows=await fetchDaySummary(currentTable,ds);card.classList.remove('loading-day');if(!rows||!rows.length){card.classList.add('no-data');card.innerHTML=`<div class="day-card-date">ğŸ“… ${ds}</div><div class="day-card-stats"><div class="day-stat"><div class="day-stat-label">ç„¡è³‡æ–™</div></div></div>`;continue;}const aHb=avg(rows.map(r=>r.heartbeat)),aSbp=avg(rows.map(r=>r.sbp)),aDbp=avg(rows.map(r=>r.dbp)),aTemp=avg(rows.map(r=>r.temp));const hbLvl=anomalyLevel('heartbeat',aHb),sbpLvl=anomalyLevel('sbp',aSbp);card.innerHTML=`<div class="day-card-date">ğŸ“… ${ds}</div><div class="day-card-stats">${aHb!==null?`<div class="day-stat"><div class="day-stat-label">â¤ï¸ å¿ƒè·³ avg</div><div class="day-stat-val${hbLvl!=='neutral'?' is-'+hbLvl:''}">${aHb}</div></div>`:''}${aSbp!==null?`<div class="day-stat"><div class="day-stat-label">ğŸ©º æ”¶ç¸®å£“ avg</div><div class="day-stat-val${sbpLvl!=='neutral'?' is-'+sbpLvl:''}">${aSbp}</div></div>`:''}${aDbp!==null?`<div class="day-stat"><div class="day-stat-label">ğŸ’™ èˆ’å¼µå£“ avg</div><div class="day-stat-val">${aDbp}</div></div>`:''}${aTemp!==null?`<div class="day-stat"><div class="day-stat-label">ğŸŒ¡ï¸ é«”æº« avg</div><div class="day-stat-val">${aTemp}Â°C</div></div>`:''}</div><div class="day-card-footer"><span>${rows.length.toLocaleString()} ç­†ï¼ˆå–æ¨£ï¼‰</span><span style="color:var(--mint-mid);font-weight:600;">æŸ¥çœ‹è©³ç´° â†’</span></div>`;card.onclick=()=>{currentDate=ds;setView('day');};}countEl.style.visibility='visible';countEl.innerHTML=`${currentMonth} æœˆä»½ãƒ»å·²è¼‰å…¥ <strong>${daysInMonth}</strong> å¤©`;}

function aggregateToMinutes(rows){const buckets={};rows.forEach(r=>{const d=new Date(r.date_minute);const key=`${r.date_minute.slice(0,11)}${p2(d.getHours())}:${p2(d.getMinutes())}`;if(!buckets[key])buckets[key]={time:r.date_minute.slice(0,11)+p2(d.getHours())+':'+p2(d.getMinutes())+':00',rows:[]};buckets[key].rows.push(r);});const af=(arr,f)=>{const n=arr.map(r=>parseFloat(r[f])).filter(v=>!isNaN(v));if(!n.length)return null;return Math.round(n.reduce((a,b)=>a+b,0)/n.length*10)/10;};return Object.values(buckets).map(b=>({time:b.time,count:b.rows.length,heartbeat:af(b.rows,'heartbeat'),temp:af(b.rows,'temp'),breath:af(b.rows,'breath'),sbp:af(b.rows,'sbp'),dbp:af(b.rows,'dbp'),pulse:af(b.rows,'pulse'),step:af(b.rows,'step'),calorie:af(b.rows,'calorie')}));}
function groupByHour(minuteRows){const hours={};minuteRows.forEach(r=>{const hk=r.time.slice(11,13);if(!hours[hk])hours[hk]=[];hours[hk].push(r);});return hours;}

function renderPage(){if(!groupedCache)return;const content=document.getElementById('table-content'),pagWrap=document.getElementById('pagination-wrap');const hourKeys=Object.keys(groupedCache).sort();const start=(currentPage-1)*HOURS_PER_PAGE;const pageHours=hourKeys.slice(start,start+HOURS_PER_PAGE);content.innerHTML='';let theadHtml='<tr>';AGG_COLS.forEach(c=>{theadHtml+=`<th>${c.label}</th>`;});theadHtml+='</tr>';const totalMins=hourKeys.reduce((s,hk)=>s+groupedCache[hk].length,0);const dateCard=document.createElement('div');dateCard.className='date-card open';let hourCardsHtml='';pageHours.forEach((hk,hi)=>{const rows=groupedCache[hk];const nextH=p2(parseInt(hk)+1);const aHb=avg(rows.map(r=>r.heartbeat)),aSbp=avg(rows.map(r=>r.sbp)),aDbp=avg(rows.map(r=>r.dbp)),aTemp=avg(rows.map(r=>r.temp));const hbLvl=anomalyLevel('heartbeat',aHb),sbpLvl=anomalyLevel('sbp',aSbp);const statsHtml=[aHb!==null?`<div class="stat-chip"><span class="stat-icon">â¤ï¸</span><span class="stat-val${hbLvl!=='neutral'?' is-'+hbLvl:''}">${aHb}</span></div>`:'',aSbp!==null?`<div class="stat-chip"><span class="stat-icon">ğŸ©º</span><span class="stat-val${sbpLvl!=='neutral'?' is-'+sbpLvl:''}">${aSbp}</span></div>`:'',aDbp!==null?`<div class="stat-chip"><span class="stat-icon">ğŸ’™</span><span class="stat-val">${aDbp}</span></div>`:'',aTemp!==null?`<div class="stat-chip"><span class="stat-icon">ğŸŒ¡ï¸</span><span class="stat-val">${aTemp}Â°C</span></div>`:''].join('');const spk=sparkline(rows.map(r=>r.heartbeat),'#7aaa96');let tbodyHtml='';rows.forEach(r=>{tbodyHtml+='<tr>';AGG_COLS.forEach(c=>{let val=r[c.key],cell;if(c.key==='time')cell=`<span class="val-neutral">${formatMinute(val)}</span>`;else if(c.key==='count')cell=`<span class="val-count">${val}</span>`;else if(val===null||val===undefined)cell='<span class="val-dim">â€”</span>';else if(c.badge){const lvl=anomalyLevel(c.key,val);const disp=c.key==='temp'?parseFloat(val).toFixed(1)+'Â°C':val;cell=lvl==='neutral'?`<span class="val-neutral">${disp}</span>`:`<span class="val-badge val-${lvl}">${disp}</span>`;}else cell=`<span class="val-neutral">${val}</span>`;tbodyHtml+=`<td>${cell}</td>`;});tbodyHtml+='</tr>';});const isOpen=hi===0?' open':'';hourCardsHtml+=`<div class="hour-card${isOpen}"><div class="hour-header" onclick="this.parentElement.classList.toggle('open')"><div class="hour-label">${hk}:00 â€“ ${nextH}:00</div><div class="hour-count">${rows.length} åˆ†é˜</div><div class="hour-stats">${statsHtml}</div><svg class="hour-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg></div><div class="hour-body"><div class="sparkline-area"><div class="spark-item"><div class="spark-label">å¿ƒè·³è¶¨å‹¢</div>${spk}</div></div><div class="data-table-wrap"><table class="data-table"><thead>${theadHtml}</thead><tbody>${tbodyHtml}</tbody></table></div></div></div>`;});dateCard.innerHTML=`<div class="date-header" onclick="this.parentElement.classList.toggle('open')"><div class="date-header-left"><div class="date-icon">ğŸ“…</div><div><div class="date-label">${currentDate}</div><div class="date-meta">${hourKeys.length} å€‹æ™‚æ®µãƒ»${totalMins.toLocaleString()} åˆ†é˜ç´€éŒ„</div></div></div><svg class="date-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg></div><div class="date-body">${hourCardsHtml}</div>`;content.appendChild(dateCard);renderPagination(pagWrap,hourKeys.length);}

function renderPagination(wrap,totalHours){totalPages=Math.ceil(totalHours/HOURS_PER_PAGE);wrap.innerHTML='';if(totalPages<=1)return;const prev=document.createElement('button');prev.className='page-btn';prev.textContent='â†';if(currentPage===1)prev.disabled=true;prev.onclick=()=>{currentPage--;renderPage();};wrap.appendChild(prev);for(let i=1;i<=totalPages;i++){const btn=document.createElement('button');btn.className='page-btn'+(i===currentPage?' active':'');btn.textContent=i;btn.onclick=(function(p){return()=>{currentPage=p;renderPage();};})(i);wrap.appendChild(btn);}const info=document.createElement('span');info.className='page-info';info.textContent=`ç¬¬ ${currentPage} / ${totalPages} é `;wrap.appendChild(info);const next=document.createElement('button');next.className='page-btn';next.textContent='â†’';if(currentPage===totalPages)next.disabled=true;next.onclick=()=>{currentPage++;renderPage();};wrap.appendChild(next);}

loadRemembered();
(async()=>{const{data:{session}}=await sb.auth.getSession();if(session?.user?.email&&ACCESS_MAP[session.user.email])showDashboard(session.user.email);})();
</script>
</body>
</html>
